# Документация по Ngine CLI
## Команда `train`

Выполняет подготовку тренировочных данных по заданным проекциям и иницирует запуск процесса обучения `h5 keras` модели искусственной нейронной сети.

## Справка
___
> `.\Ngine.CommandLine.exe train -?`

```bash
Usage: Ngine.CommandLine train [options] <ModelPath> <-m|--mappings> <-e|--epochs> <-b|--batch> <-vs|--validation-split>

Arguments:
  ModelPath
  -m|--mappings
  -e|--epochs
  -b|--batch
  -vs|--validation-split

Options:
  -?|-h|--help            Show help information
```

- Позиционный аргумент `model-path` определяет путь к `h5` файлу модели, полученного в результате выполнения [команды](compile-cli-command.cmd) `.\Ngine.CommandLine.exe compile`
- Позиционный аргумент `mappings` задает путь к [файлу проекций](#проекции).
- Позиционный целочисленный аргумент `epochs` задает количество эпох обучения
- Позиционный целочисленный аргумент `batch-size` задает размер группы (серии) обучения (не должен превышать число эпох) 
- Позиционный вещественный аргумент `validation-split` принимает значения от 0 до 1. Задает коэффициент по которому совершается разделение выборки на тренировочную и тестовую

## Проекции
___

Файл проекций задает правила по которым следует отображать данные из различных источников на входы и выходы обучаемой искусственной нейронной сети. 

В качестве источников данных могут выступать локальные директории файлов с изображениями, csv-документы или их комбинации.

В общем виде файл проекций содержит следующие поля:

- `files` - список назначений имен для файлов и директорий, использующихся в проекциях
- `inputs` - список элементов `projections` для каждого из входных слоев
- `outputs` - список элементов `projections` для каждого из выходных слоев

### Синтаксис
Каждый из элементов `projections` имеет следующий [вид](ngine-schema.md):

```bash
-> projection: '{{ type: (lin|cats|cons|img) }}:${{ ref: word }}({{ slice: slice }})?'
    -> slice: '[({{ start: uint }})?(:({{ last: uint }})?)?]'
        -> uint: 'positive integer'
```

### Параметры:
- `type` - целевой тип проекции. 
- `ref` - ссылка на элемент `files`. Источник данных для проекции
- `slice` - определяет срез колонок csv-файла, участвующих в некоторых проекциях. Не поддерживается для `ref`, являющимися директорией.


Параметр `projections.slice` может принимать следующие значения:
- одно число - номер колонки, участвующией в проекции
- срез ( `start:` | `start:end` | `:end` | `:` ) - массив из подрядыдущих номеров колонок, участвующих в одной проекции.


Параметр `projections.type` доопускает следующие значения:
- `lin` (сокр. linear) - линейная величина. csv-only. Допустимы любые значения `slice`. 
    
    Принимает на вход одну или несколько числовых колонок csv-файла и возвращает их без изменения.

- `cons` (сокр. continuous) - линейная величина. csv-only. Допустимы любые значения `slice`. 
    
    Принимает на вход одну или несколько числовых колонок csv-файла и возвращает их номализованные значения.
    
    Нормализация проводится по значению наибольшего и наименьшего числа в колонке (`min-max-scale`).

    При такой нормализации для чисел `[1, 5, 2, 3]`, 
    результат кодирования будет равен `[0, 1, 0.25, 0.5]`

- `cats` (сокр. categorical) - строковая величина. Определяется как категориальный признак. csv-only. Допустимы любые значения `slice`.
  
    Принимает на вход одну или несколько строковых колонок csv-файла и возвращает плоский список чисел, полученных в результате применения кодирования `one-hot-encoding` к признакам.
    
    | 0 | 1 | `2`     | `3`     | 4 |
    | - | - | ------- | ------- | - |
    | 1 | 3 | `red`   | `true`  | a |
    | 3 | 4 | `blue`  | `false` | b |
    | 1 | 2 | `green` | `false` | a |
    | 3 | 3 | `blue`  | `true`  | c |

    Для файла представленного выше проекция `cats:$file1[2:3]` будет давать тот же результат, что и проекция `lin:$file2[:]` для следующей таблицы:

    | `red` | `blue` | `green` | `true` | `false` |
    | ----- | ------ | ------- | ------ | ------- |
    | 1     | 0      | 0       | 1      | 0       |
    | 0     | 1      | 0       | 0      | 1       |
    | 0     | 0      | 1       | 0      | 1       |
    | 0     | 1      | 0       | 1      | 0       |
    
- `img` (сокр. image) - изображение. Определяется как многомерный числовой признак. csv и директории.

    Принимает несколько подрядыдущих числовых колонок csv-файла и возвращает объект, сформированный из этих значений и имеющий размерность как у входаного слоя, к которому совершена проекция.

    | 0   | `1`  | `2`   | `3`   | `4`   | `...` | `785` |
    | --- | ---  | ----- | ----- | ----- | ----- | ----- |
    | 4   | `0`  | `101` | `200` | `0`   | `...` | `0`   |
    | 7   | `54` | `12`  | `0`   | `192` | `...` | `0`   |
    | 5   | `12` | `13`  | `200` | `0`   | `...` | `0`   |

    При совершении проекции `img:file[1:]` на вход с размерностью `1:[28x28]` происходит реформатирование `1-785` колонок к списку массивов размерности `1x28x28` и в таком виде подается на вход нейронной сети.


## Примеры:
Запуск [lenet-5](..\samples\network-definition.yaml) с проекциями [mnist_data_header.yaml](..\samples\mnist_data_header.yaml) на 10000 записей датасета [mnist-in-csv](https://www.kaggle.com/oddrationale/mnist-in-csv).

```bash
$> $model = 'models\model-2020-05-02-035451.5009.h5'
$> $mappings = '..\samples\mnist_data_header.yaml'
$> .\Ngine.CommandLine.exe train $model $mappings 200 20 0,2

==== summary ====
Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
1-1 (InputLayer)             (None, 28, 28, 1)         0
_________________________________________________________________
2-1 (Conv2D)                 (None, 28, 28, 6)         156
_________________________________________________________________
3-1 (Activation)             (None, 28, 28, 6)         0
_________________________________________________________________
4-1 (AveragePooling2D)       (None, 14, 14, 6)         0
_________________________________________________________________
5-1 (Conv2D)                 (None, 12, 12, 16)        880
_________________________________________________________________
6-1 (Activation)             (None, 12, 12, 16)        0
_________________________________________________________________
7-1 (AveragePooling2D)       (None, 6, 6, 16)          0
_________________________________________________________________
8-1 (Conv2D)                 (None, 2, 2, 3)           1203
_________________________________________________________________
9-1 (Activation)             (None, 2, 2, 3)           0
_________________________________________________________________
10-1 (Flatten)               (None, 12)                0
_________________________________________________________________
11-1 (Dense)                 (None, 84)                1092
_________________________________________________________________
12-1 (Activation)            (None, 84)                0
_________________________________________________________________
13-1 (Dense)                 (None, 10)                850
_________________________________________________________________
softmax_1 (Softmax)          (None, 10)                0
=================================================================
Total params: 4,181
Trainable params: 4,181
Non-trainable params: 0
_________________________________________________________________

[INFO] input 0 shape is (28, 28, 1)
[DEBUG] columns range(1, 785) of (28, 28, 1) images

[INFO] output 0 shape is (10,)
[DEBUG] column 0 of 10 categories: ['0' '1' '2' '3' '4' '5' '6' '7' '8' '9']

[INFO] training model...
Train on 8000 samples, validate on 2000 samples
Epoch 1/20

 200/8000 [..............................] - ETA: 57s - loss: 2.3027
 400/8000 [>.............................] - ETA: 30s - loss: 2.3047
 600/8000 [=>............................] - ETA: 21s - loss: 2.3076
 800/8000 [==>...........................] - ETA: 17s - loss: 2.3019
1000/8000 [==>...........................] - ETA: 14s - loss: 2.2984
1200/8000 [===>..........................] - ETA: 12s - loss: 2.2954
1400/8000 [====>.........................] - ETA: 11s - loss: 2.2928
...
6000/8000 [=====================>........] - ETA: 1s - loss: 0.3673
6200/8000 [======================>.......] - ETA: 1s - loss: 0.3688
6400/8000 [=======================>......] - ETA: 0s - loss: 0.3697
6600/8000 [=======================>......] - ETA: 0s - loss: 0.3685
6800/8000 [========================>.....] - ETA: 0s - loss: 0.3692
7000/8000 [=========================>....] - ETA: 0s - loss: 0.3685
7200/8000 [==========================>...] - ETA: 0s - loss: 0.3674
7400/8000 [==========================>...] - ETA: 0s - loss: 0.3674
7600/8000 [===========================>..] - ETA: 0s - loss: 0.3677
7800/8000 [============================>.] - ETA: 0s - loss: 0.3664
8000/8000 [==============================] - 5s 684us/step - loss: 0.3660 - val_loss: 0.3537

[INFO] model weights saved models\model-2020-05-02-035451.5009-weights.h5
```